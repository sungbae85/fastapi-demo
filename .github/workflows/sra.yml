  name: sra

  on:
    pull_request:
    push:
      branches: [ main ]

  permissions:
    contents: read

  jobs:
    sra:
      runs-on: ubuntu-latest

      steps:
        # 1) 대상 레포 체크아웃 (fastapi-demo)
        - name: Checkout target repo (fastapi-demo)
          uses: actions/checkout@v4

        # 2) Python 준비
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: "3.11"

        - name: Debug Token Length Temp
          env:
            MY_TOKEN: ${{ secrets.SRA_REPO_TOKEN }}
          run: |
            if [ -z "$MY_TOKEN" ]; then
              echo "❌ 토큰이 비어있습니다! Secret 설정을 확인하세요."
            else
              echo "✅ 토큰이 존재합니다. (길이: ${#MY_TOKEN} 자)"
            fi

        # 3) SRA 설치 (버전 고정: E-9 핵심)
        # - worksra를 checkout 하지 않음
        # - Git tag 기반으로 설치 (재현성 확보)
        - name: Install SRA (version pinned)
          env:
            GIT_TOKEN: ${{ secrets.SRA_REPO_TOKEN }}
          run: |
            python -m pip install -U pip
            pip install "git+https://x-access-token:${GIT_TOKEN}@github.com/sungbae85/worksra.git@v0.2.11-20251225"

        # 4) 분석 도구 설치
        # 이미 설치돼 있으면 pip가 알아서 skip 함
        - name: Install analyzers (dev tools)
          run: |
            python -m pip install -U pip
            pip install ruff mypy bandit pytest pytest-cov

        # 5) semgrep 설치 (pipx, warn-only)
        - name: Install semgrep via pipx (isolated, warn-only)
          continue-on-error: true
          run: |
            python -m pip install -U pip pipx
  
            # pipx 바이너리 경로를 PATH에 추가 (다음 step에서도 유지)
            echo "$HOME/.local/bin" >> "$GITHUB_PATH"
  
            # 이미 설치돼 있으면 skip
            pipx install semgrep || echo "semgrep already installed"
  
            which semgrep || true
            semgrep --version || true

        # 6) SRA 설치 확인 (진단용, warn-only)
        - name: Verify SRA installation (warn-only)
          continue-on-error: true
          run: |
            sra --help || true
            python -c "import importlib.metadata as m; print('sra version:', m.version('sra'))" || true

        # 7) repo root의 sra.yml 확인 (진단용)
        - name: "Debug: show repo root sra.yml (before scan/gate)"
          continue-on-error: true
          run: |
            echo "== PWD =="
            pwd
            echo "== list root =="
            ls -la
            echo "== show ./sra.yml =="
            if [ -f ./sra.yml ]; then cat ./sra.yml; else echo "MISSING: ./sra.yml"; fi

        # 8) SRA scan (LLM off)
        - name: Run SRA scan
          run: |
            sra scan --use-llm off --config ./sra.yml

        # 9) 산출물 업로드 (항상)
        - name: Upload SRA reports (always)
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: sra-reports
            path: reports/
            if-no-files-found: warn

        # 10) Gate 설정 로딩 확인 (warn-only)
        - name: "Debug: print active profile (warn-only)"
          continue-on-error: true
          run: |
            python -c "from sra.config import load_config, get_active_profile; from pathlib import Path; cfg=load_config(Path('.'), explicit=Path('./sra.yml')); prof=get_active_profile(cfg); print('active profile:', prof.name); print('gates:', prof.gates)"

        # 11) Gate (실패하면 job 실패 = 정상 동작)
        - name: Run SRA gate
          run: |
            sra gate --config ./sra.yml

        - name: Post PR Comment
          if: github.event_name == 'pull_request'
          uses: mshick/add-pr-comment@v2
          with:
            message-path: reports/latest/pr_comment.md
