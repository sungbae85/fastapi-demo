name: SRA CI (Version Managed)

on:
  pull_request:
  push:
    branches: ['main']

# 1. 관리 포인트를 최상단 env로 집중
env:
  # 경로 설정
  VENV_PY: 'C:\worksra\.venv\Scripts\python.exe'
  VENV_BIN: 'C:\worksra\.venv\Scripts'
  # 도구 버전 (사용자님 로컬 환경과 동기화)
  RUFF_VER: '0.14.10'
  MYPY_VER: '1.19.1'
  BANDIT_VER: '1.9.2'
  PYTEST_VER: '9.0.2'
  # LLM 설정
  SRA_LLM_ENDPOINT: 'http://127.0.0.1:11434/v1'
  PLANNER_MODEL: 'gemma3:4b'
  PATCHER_MODEL: 'codegemma:2b'

  # 테스트용 SRA 버전 및 저장소 정보
  SRA_REPO_URL: 'https://github.com/sungbae85/worksra.git'
  SRA_TAG: 'v0.2.14-20251227' # 태그 버전


jobs:
  sra:
    runs-on: [self-hosted, 4ollama]
    # 2. 반복되는 powershell 설정을 기본값으로 지정
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install (Git Tag with No-Isolation)
        run: |
          $TRUSTED = "--trusted-host", "pypi.org", "--trusted-host", "files.pythonhosted.org", "--trusted-host", "github.com"
          
          Write-Host "Installing SRA from Git Tag: ${{ env.SRA_TAG }}..."
          # ✅ --no-build-isolation 옵션을 추가하여 인터넷 접속을 원천 차단합니다.
          & "${{ env.VENV_PY }}" -m pip install $TRUSTED `
            --no-build-isolation `
            "git+${{ env.SRA_REPO_URL }}@${{ env.SRA_TAG }}"
          
          Write-Host "Installing other tools..."
          & "${{ env.VENV_PY }}" -m pip install $TRUSTED `
            ruff==${{ env.RUFF_VER }} `
            mypy==${{ env.MYPY_VER }} `
            bandit==${{ env.BANDIT_VER }} `
            pytest==${{ env.PYTEST_VER }} `
            pytest-cov requests python-dotenv

      - name: Run SRA Scan (Ultimate Path Fix)
        env:
          SRA_PLANNER_MODEL: ${{ env.PLANNER_MODEL }}
          SRA_PATCHER_MODEL: ${{ env.PATCHER_MODEL }}
        run: |
          # ✅ 1. 부모 폴더로 이동하여 'fastapi-demo'라는 이름을 SRA가 인식하게 합니다.
          cd ..
          $TARGET_REPO = (Get-Item ".").FullName
          Write-Host "Forcing Repo Root to: $TARGET_REPO"
          
          $env:Path = "${{ env.VENV_BIN }};" + $env:Path
          
          # ✅ 2. --repo를 현재 부모 폴더(.)로 설정하고, 컨텍스트를 강제로 전체 수집(all)합니다.
          & "${{ env.VENV_PY }}" -m sra scan `
            --repo . `
            --use-llm on `
            --context-mode all `
            --config "./fastapi-demo/sra.yml"

      - name: Gate
        run: |
          cd ..
          & '${{ env.VENV_PY }}' -m sra gate
