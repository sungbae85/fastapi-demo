name: SRA CI (Independent Tag-Based)

on:
  pull_request:
  push:
    branches: ['main']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # 시스템 고정 경로 (러너 PC의 도구 위치)
  VENV_PY: 'C:\worksra\.venv\Scripts\python.exe'
  VENV_BIN: 'C:\worksra\.venv\Scripts'

  # [버전 관리] 중앙 SRA 저장소 및 태그 정보
  SRA_REPO_URL: 'https://github.com/sungbae85/worksra.git'
  SRA_TAG: 'v0.2.16-20251231' # 최신 패치 버전

  # 분석 도구 버전 고정
  RUFF_VER: '0.14.10'
  MYPY_VER: '1.19.1'
  BANDIT_VER: '1.9.2'
  PYTEST_VER: '9.0.2'

  # LLM 설정
  PLANNER_MODEL: 'gemma3:4b'
  PATCHER_MODEL: 'codegemma:2b'

jobs:
  sra:
    runs-on: [self-hosted, 4ollama]
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install SRA from Git Tag
        run: |
          $TRUSTED = "--trusted-host", "pypi.org", "--trusted-host", "files.pythonhosted.org", "--trusted-host", "github.com"
          
          Write-Host " Installing SRA Version: ${{ env.SRA_TAG }} directly from Central Repo..."
          # 로컬 폴더 참조가 아닌, Git Tag에서 직접 설치 (격리 및 독립성 확보)
          & "${{ env.VENV_PY }}" -m pip install $TRUSTED `
            --force-reinstall `
            "git+${{ env.SRA_REPO_URL }}@${{ env.SRA_TAG }}"
          
          Write-Host "️ Ensuring analysis tools are synced..."
          & "${{ env.VENV_PY }}" -m pip install $TRUSTED `
            ruff==${{ env.RUFF_VER }} mypy==${{ env.MYPY_VER }} `
            bandit==${{ env.BANDIT_VER }} pytest==${{ env.PYTEST_VER }} `
            pytest-cov requests python-dotenv

      - name: Set Run ID
        run: |
          $RID = "${{ github.run_id }}-${{ github.run_attempt }}"
          echo "SRA_RUN_ID=$RID" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Unique Execution ID: $RID"

      - name: Run SRA Scan (Strict Enterprise Mode)
        env:
          SRA_PLANNER_MODEL: ${{ env.PLANNER_MODEL }}
          SRA_PATCHER_MODEL: ${{ env.PATCHER_MODEL }}
        run: |
          cd ..
          $env:Path = "${{ env.VENV_BIN }};" + $env:Path
          
          # Git Tag 버전의 엔진을 사용하여 분석 수행
          # --user와 --run-id를 통한 완벽한 다중 사용자 격리
          & "${{ env.VENV_PY }}" -m sra scan `
            --repo . `
            --run-id "$env:SRA_RUN_ID" `
            --user "${{ github.actor }}" `
            --use-llm on `
            --config "./${{ github.event.repository.name }}/sra.yml"

      - name: Gate (Strict Isolation)
        if: always()
        run: |
          cd ..
          # 명시적 경로 지정을 통한 게이트 통과 검증
          & "${{ env.VENV_PY }}" -m sra gate `
            --report "./reports/$env:SRA_RUN_ID/report.json" `
            --config "./${{ github.event.repository.name }}/sra.yml"

      - name: Cleanup Reports
        if: always()
        run: |
          $limit = (Get-Date).AddDays(-2)
          $reportPath = "../reports" 
          if (Test-Path $reportPath) {
              Get-ChildItem -Path $reportPath -Directory | Where-Object { $_.CreationTime -lt $limit } | Remove-Item -Recurse -Force
          }
