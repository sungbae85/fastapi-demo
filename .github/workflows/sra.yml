name: SRA CI (Enterprise Managed)

on:
  pull_request:
  push:
    branches: ['main']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # G-1: 시스템 고정 경로 (러너 PC 인프라)
  VENV_PY: 'C:\worksra\.venv\Scripts\python.exe'
  VENV_BIN: 'C:\worksra\.venv\Scripts'

  # G-2: 프로젝트 격리 절대 경로
  SRA_DATA_ROOT: 'C:\sra_data'

  # [버전 관리] 최종 패치 버전 동기화
  SRA_REPO_URL: 'https://github.com/sungbae85/worksra.git'
  SRA_TAG: 'v0.2.24-20260101'

jobs:
  sra:
    runs-on: [self-hosted, 4ollama]
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install SRA Engine
        run: |
          $TRUSTED = "--trusted-host", "pypi.org", "--trusted-host", "files.pythonhosted.org", "--trusted-host", "github.com"
          
          Write-Host "Syncing SRA Engine Version: ${{ env.SRA_TAG }}..."
          # 빌드 도구 최신화 및 엔진 설치 (WinError 2 방지용 도구 포함)
          & "${{ env.VENV_PY }}" -m pip install $TRUSTED --upgrade pip setuptools wheel
          & "${{ env.VENV_PY }}" -m pip install $TRUSTED --force-reinstall "git+${{ env.SRA_REPO_URL }}@${{ env.SRA_TAG }}"

      - name: Set Run ID
        run: |
          $RID = "${{ github.run_id }}-${{ github.run_attempt }}"
          echo "SRA_RUN_ID=$RID" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run SRA Scan (G-2 Isolated Mode)
        run: |
          # 가상환경 경로를 PATH에 추가하여 ruff, mypy 등 실행 보장
          $env:Path = "${{ env.VENV_BIN }};" + $env:Path
          
          # ✅ --repo . 를 사용하여 현재 프로젝트(fastapi-demo)를 자동 감지
          & "${{ env.VENV_PY }}" -m sra scan `
            --repo . `
            --user "${{ github.actor }}" `
            --data-root "${{ env.SRA_DATA_ROOT }}" `
            --run-id "$env:SRA_RUN_ID" `
            --use-llm on

      - name: Run SRA Gate (Dynamic Discovery)
        if: always()
        run: |
          $env:Path = "${{ env.VENV_BIN }};" + $env:Path
          
          # ✅ 엔진이 스스로 C:\sra_data\fastapi-demo\{RID}\report.json을 찾아감
          & "${{ env.VENV_PY }}" -m sra gate `
            --repo . `
            --data-root "${{ env.SRA_DATA_ROOT }}" `
            --run-id "$env:SRA_RUN_ID"

      - name: V-4-4 Slack Notification
        #if: failure() # 스캔 실패 시에만 알림 발송
        if: always()
        env:
          SLACK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          & "${{ env.VENV_PY }}" -m sra notify `
            --run-id "$env:SRA_RUN_ID" `
            --repo . `
            --data-root "${{ env.SRA_DATA_ROOT }}" `
            --webhook-url "${{ env.SLACK_URL }}" `
            --user "${{ github.actor }}"

      - name: "Cleanup Old Reports"
        if: always()
        run: |
          $limit = (Get-Date).AddDays(-2)
          # G-2: 격리 폴더(fastapi-demo) 하위의 오래된 리포트 삭제
          $targetPath = Join-Path "${{ env.SRA_DATA_ROOT }}" "fastapi-demo"
          if (Test-Path $targetPath) {
              Get-ChildItem -Path $targetPath -Directory | Where-Object { $_.CreationTime -lt $limit } | ForEach-Object {
                  Remove-Item -Path $_.FullName -Recurse -Force
              }
          }
