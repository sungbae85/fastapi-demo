name: SRA CI (Version Managed)

on:
  pull_request:
  push:
    branches: ['main']

# 1. 관리 포인트를 최상단 env로 집중
env:
  # 경로 설정
  VENV_PY: 'C:\worksra\.venv\Scripts\python.exe'
  VENV_BIN: 'C:\worksra\.venv\Scripts'
  # 도구 버전 (사용자님 로컬 환경과 동기화)
  RUFF_VER: '0.14.10'
  MYPY_VER: '1.19.1'
  BANDIT_VER: '1.9.2'
  PYTEST_VER: '9.0.2'
  # LLM 설정
  SRA_LLM_ENDPOINT: 'http://127.0.0.1:11434/v1'
  PLANNER_MODEL: 'gemma3:4b'
  PATCHER_MODEL: 'codegemma:2b'

jobs:
  sra:
    runs-on: [self-hosted, 4ollama]
    # 2. 반복되는 powershell 설정을 기본값으로 지정
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install (Version Synced)
        run: |
          Write-Host "Checking Environment..."
          & "${{ env.VENV_PY }}" --version # 파이썬 3.11.0 확인
          
          # ✅ 해결책: 쉼표(,)를 사용해 배열로 선언합니다. 
          # 이렇게 하면 파워쉘이 각각의 인자를 pip에게 따로따로 잘 전달해줍니다.
          $TRUSTED = "--trusted-host", "pypi.org", "--trusted-host", "files.pythonhosted.org"
          
          Write-Host "Installing SRA..."
          & "${{ env.VENV_PY }}" -m pip install $TRUSTED --no-build-isolation --no-deps -e .
          
          Write-Host "Installing pinned versions of tools..."
          & "${{ env.VENV_PY }}" -m pip install $TRUSTED `
            ruff==${{ env.RUFF_VER }} `
            mypy==${{ env.MYPY_VER }} `
            bandit==${{ env.BANDIT_VER }} `
            pytest==${{ env.PYTEST_VER }} `
            pytest-cov requests python-dotenv

      - name: Run SRA Scan
        env:
          SRA_PLANNER_MODEL: ${{ env.PLANNER_MODEL }}
          SRA_PATCHER_MODEL: ${{ env.PATCHER_MODEL }}
        run: |
          # PATH 추가 로직을 환경 변수 활용으로 단순화
          $env:Path = '${{ env.VENV_BIN }};' + $env:Path
          & '${{ env.VENV_PY }}' -m sra scan --repo . --use-llm on --context-mode changed_only

      - name: Gate
        run: |
          & '${{ env.VENV_PY }}' -m sra gate
