name: sra

on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  sra:
    runs-on: ubuntu-latest
    steps:
      # 1) 대상 레포 체크아웃
      - name: Checkout target repo (fastapi-demo)
        uses: actions/checkout@v4

      # 2) SRA 엔진 레포 체크아웃 (Private 접근: PAT Secret 사용)
      - name: Checkout SRA engine repo (worksra)
        uses: actions/checkout@v4
        with:
          repository: sungbae85/worksra
          path: worksra
          token: ${{ secrets.SRA_REPO_TOKEN }}

      # 3) 파이썬 준비
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4) SRA 설치
      - name: Install SRA (editable)
        run: |
          python -m pip install -U pip
          pip install -e ./worksra

      # 5) 설치 확인(진단용) - 실패해도 계속 진행 (warn)
      - name: Verify SRA installation (warn only)
        continue-on-error: true
        run: |
          echo "== sra command =="
          sra --help || true

          echo "== python version =="
          python --version

          echo "== rich version (safe) =="
          python -c "import importlib.metadata as m; print('rich:', m.version('rich'))" || true

          echo "== sra package check (best effort) =="
          python -c "import sra; print('sra imported:', sra.__file__)" || true

      # a1) Install analyzers (ruff/mypy/bandit/pytest)
      - name: Install analyzers (ruff/mypy/bandit/pytest)
        run: |
          pip install ruff mypy bandit pytest

      # a2) Install analyzers (dev tools)
      - name: Install analyzers (dev tools)
        run: |
          python -m pip install -U pip
          pip install -r requirements-dev.txt

      # 6) 스캔 실행 (LLM off)
      - name: Run SRA scan
        run: |
          sra scan --use-llm off

      # 7) 산출물 업로드(디버깅/감사용) - 실패해도 업로드 시도
      - name: Upload SRA reports (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sra-reports
          path: reports/
          if-no-files-found: warn

      # 8) 게이트 실행 (Gate 실패 시 job 실패가 정상)
      - name: Run SRA gate
        run: |
          sra gate
