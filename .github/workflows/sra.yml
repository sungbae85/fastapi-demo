name: SRA CI (Version Managed)

on:
  pull_request:
  push:
    branches: ['main']

# 동일 브랜치 내 중복 분석 방지 및 자원 보호
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# 1. 관리 포인트를 최상단 env로 집중
env:
  # 경로 설정
  VENV_PY: 'C:\worksra\.venv\Scripts\python.exe'
  VENV_BIN: 'C:\worksra\.venv\Scripts'
  # 도구 버전 (로컬 환경과 동기화)
  RUFF_VER: '0.14.10'
  MYPY_VER: '1.19.1'
  BANDIT_VER: '1.9.2'
  PYTEST_VER: '9.0.2'
  # LLM 설정
  SRA_LLM_ENDPOINT: 'http://127.0.0.1:11434/v1'
  PLANNER_MODEL: 'gemma3:4b'
  PATCHER_MODEL: 'codegemma:2b'

  # 테스트용 SRA 버전 및 저장소 정보
  SRA_REPO_URL: 'https://github.com/sungbae85/worksra.git'
  SRA_TAG: 'v0.2.14-20251227' # 태그 버전


jobs:
  sra:
    runs-on: [self-hosted, 4ollama]
    # 2. 반복되는 powershell 설정을 기본값으로 지정
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install (Git Tag with No-Isolation)
        run: |
          $TRUSTED = "--trusted-host", "pypi.org", "--trusted-host", "files.pythonhosted.org", "--trusted-host", "github.com"
          
          Write-Host "Installing SRA from Git Tag: ${{ env.SRA_TAG }}..."
          # --no-build-isolation 옵션을 추가하여 인터넷 접속을 원천 차단
          & "${{ env.VENV_PY }}" -m pip install $TRUSTED `
            --no-build-isolation `
            "git+${{ env.SRA_REPO_URL }}@${{ env.SRA_TAG }}"
          
          Write-Host "Installing other tools..."
          & "${{ env.VENV_PY }}" -m pip install $TRUSTED `
            ruff==${{ env.RUFF_VER }} `
            mypy==${{ env.MYPY_VER }} `
            bandit==${{ env.BANDIT_VER }} `
            pytest==${{ env.PYTEST_VER }} `
            pytest-cov requests python-dotenv

      - name: Run SRA Scan (Enterprise Mode & Strict Isolation Mode)
        env:
          SRA_PLANNER_MODEL: ${{ env.PLANNER_MODEL }}
          SRA_PATCHER_MODEL: ${{ env.PATCHER_MODEL }}
        run: |
          cd ..
          $env:Path = "${{ env.VENV_BIN }};" + $env:Path
          
          # GitHub 고유 실행 ID와 시도 횟수를 조합하여 절대 중복 없는 ID 생성
          $UNIQUE_ID = "${{ github.run_id }}-${{ github.run_attempt }}"
          Write-Host "Unique Run ID: $UNIQUE_ID"
          
          # --run-id 인자를 통해 SRA가 해당 이름으로 폴더를 만들도록 강제 & no-latest로 Strict Isolation Mode
          & "${{ env.VENV_PY }}" -m sra scan `
            --repo . `
            --run-id "$UNIQUE_ID" `
            --use-llm on `
            --context-mode changed_only `
            --no-latest `
            --config "./${{ github.event.repository.name }}/sra.yml"


      - name: Gate (Enterprise Mode)
        run: |
          cd ..
          # 스캔 시 사용한 것과 동일한 고유 ID 생성
          $UNIQUE_ID = "${{ github.run_id }}-${{ github.run_attempt }}"
          
          # 명시적으로 해당 ID 폴더 내의 report.json을 검증
          & "${{ env.VENV_PY }}" -m sra gate `
            --report "./reports/$UNIQUE_ID/report.json" `
            --config "./${{ github.event.repository.name }}/sra.yml"

      - name: "Cleanup Old Reports (Retention: 2 Days)"
        if: always() # 분석 성공/실패 여부와 관계없이 실행
        run: |
          # 2일이 지난 기록은 runner의 _work/fastapi-demo/reports/ 폴더에서 삭제
          $limit = (Get-Date).AddDays(-2)
          $reportPath = "../reports" 
          
          Write-Host "Cleaning reports older than 2 days in $reportPath ..."
          
          if (Test-Path $reportPath) {
              Get-ChildItem -Path $reportPath -Directory | Where-Object { $_.CreationTime -lt $limit } | ForEach-Object {
                  Write-Host "Removing: $($_.Name) (Created: $($_.CreationTime))"
                  Remove-Item -Path $_.FullName -Recurse -Force
              }
          }


