name: sra

on:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  sra:
    runs-on: [self-hosted, 4ollama]

    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4

      - name: Run SRA Scan with LLM On (Real Ollama)
        shell: powershell
        env:
          SRA_LLM_ENDPOINT: "http://127.0.0.1:11434/v1"
          SRA_PLANNER_MODEL: "gemma3:4b"
          SRA_PATCHER_MODEL: "codegemma:2b"
        run: |
          $VENV_BIN = "C:\worksra\.venv\Scripts"
          $VENV_PY = "$VENV_BIN\python.exe"
          
          # ✅ 핵심: 가상환경 Scripts 폴더를 PATH 맨 앞에 추가하여 ruff 등을 찾을 수 있게 함
          $env:Path = "$VENV_BIN;" + $env:Path
          
          # 이제 ruff, mypy 등을 시스템이 직접 인식합니다.
          & $VENV_PY -m sra scan --repo . --use-llm on --context-mode changed_only

      - name: Gate
        shell: powershell
        run: |
          $VENV_BIN = "C:\worksra\.venv\Scripts"
          $VENV_PY = "$VENV_BIN\python.exe"
          
          # ✅ --latest 옵션 대신 명시적 경로 사용 (Typer 호환성)
          & $VENV_PY -m sra gate

      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        uses: mshick/add-pr-comment@v2
        with:
          message-path: reports/latest/pr_comment.md
